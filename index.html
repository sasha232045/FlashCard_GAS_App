<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©¶æ¥µã®å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <style>
        /* ãƒªã‚»ãƒƒãƒˆCSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* ã‚«ãƒ¼ãƒ‰å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ */
        .study-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2rem 0;
        }

        .card-text {
            font-size: 2rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .card-memo {
            font-size: 1rem;
            color: #666;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .card-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .flip-btn {
            background: #28a745;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flip-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³ */
        .status-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 0.3rem 0.8rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .status-æœªç€æ‰‹ { background: #6c757d; color: white; }
        .status-å­¦ç¿’ä¸­ { background: #007bff; color: white; }
        .status-è‹¦æ‰‹ãƒ»è¦å¾©ç¿’ { background: #dc3545; color: white; }
        .status-å®šç€ { background: #ffc107; color: black; }
        .status-ç¿’å¾—æ¸ˆã¿ { background: #28a745; color: white; }

        /* è©•ä¾¡ãƒœã‚¿ãƒ³ */
        .rating-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .rating-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .rating-btn:nth-child(1) { background: #dc3545; color: white; }
        .rating-btn:nth-child(2) { background: #fd7e14; color: white; }
        .rating-btn:nth-child(3) { background: #ffc107; color: black; }
        .rating-btn:nth-child(4) { background: #28a745; color: white; }
        .rating-btn:nth-child(5) { background: #20c997; color: white; }

        /* ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ */
        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
        }

        .table-controls {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .form-control {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        /* è¨­å®šç”»é¢ */
        .settings-panel {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .setting-label {
            flex: 1;
            min-width: 200px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        /* èª­ã¿ä¸Šã’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .audio-controls {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .audio-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .speed-control {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .speed-slider {
            width: 100%;
        }

        /* ç™ºéŸ³ç·´ç¿’ */
        .speech-practice {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: #dc3545;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem;
        }

        .mic-button:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .mic-button.recording {
            background: #28a745;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .nav-buttons {
                justify-content: center;
            }

            .card-text {
                font-size: 1.5rem;
            }

            .card-controls {
                flex-direction: column;
                align-items: center;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .status-buttons,
            .rating-buttons {
                justify-content: center;
            }

            .setting-item {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 0.8rem;
            }

            .audio-settings {
                grid-template-columns: 1fr;
            }
        }

        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #6c757d;
        }

        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <div class="logo">ğŸ“š ç©¶æ¥µã®å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª</div>
            <nav class="nav-buttons">
                <button class="btn btn-primary" onclick="showStudyMode()">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
                <button class="btn btn-secondary" onclick="showDataManager()">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>
                <button class="btn btn-secondary" onclick="showSettings()">è¨­å®š</button>
                <button class="btn btn-secondary" onclick="showReviewMode()">ä»Šæ—¥ã®å¾©ç¿’</button>
            </nav>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="container">
        <!-- å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="studyMode" class="study-mode">
            <!-- èª­ã¿ä¸Šã’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="audio-controls">
                <h3>èª­ã¿ä¸Šã’è¨­å®š</h3>
                <div class="audio-settings">
                    <div class="speed-control">
                        <label>è‹±èªèª­ã¿ä¸Šã’é€Ÿåº¦: <span id="englishSpeedValue">1.0</span></label>
                        <input type="range" class="speed-slider" id="englishSpeed" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="speed-control">
                        <label>æ—¥æœ¬èªèª­ã¿ä¸Šã’é€Ÿåº¦: <span id="japaneseSpeedValue">1.0</span></label>
                        <input type="range" class="speed-slider" id="japaneseSpeed" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div>
                        <label><input type="checkbox" id="autoPlay"> è‡ªå‹•å†ç”Ÿ</label>
                    </div>
                    <div>
                        <label><input type="checkbox" id="loopMode"> ãƒ«ãƒ¼ãƒ—å†ç”Ÿ</label>
                    </div>
                    <div>
                        <label>å†ç”Ÿæšæ•°: 
                            <select id="playCount">
                                <option value="1">1æš</option>
                                <option value="10">10æš</option>
                                <option value="20">20æš</option>
                                <option value="all">å…¨ã¦</option>
                            </select>
                        </label>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="playCustomAudio()">ã‚«ã‚¹ã‚¿ãƒ èª­ã¿ä¸Šã’é–‹å§‹</button>
                    <button class="btn btn-secondary" onclick="stopAudio()">åœæ­¢</button>
                </div>
            </div>

            <!-- å­¦ç¿’ã‚«ãƒ¼ãƒ‰ -->
            <div class="study-card">
                <div class="card-content">
                    <div id="cardText" class="card-text">å­¦ç¿’ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
                    <div id="cardMemos"></div>
                    <div class="status-buttons">
                        <button class="status-btn" data-skill="listening" onclick="toggleStatus('listening')">L: æœªç€æ‰‹</button>
                        <button class="status-btn" data-skill="reading" onclick="toggleStatus('reading')">R: æœªç€æ‰‹</button>
                        <button class="status-btn" data-skill="speaking" onclick="toggleStatus('speaking')">S: æœªç€æ‰‹</button>
                        <button class="status-btn" data-skill="writing" onclick="toggleStatus('writing')">W: æœªç€æ‰‹</button>
                    </div>
                </div>
                
                <div class="card-controls">
                    <button class="flip-btn" onclick="flipCard()">ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹</button>
                    <button class="btn btn-secondary" onclick="speakText()">ğŸ”Š èª­ã¿ä¸Šã’</button>
                    <button class="btn btn-secondary" onclick="prevCard()">â† å‰</button>
                    <button class="btn btn-secondary" onclick="nextCard()">æ¬¡ â†’</button>
                </div>

                <!-- è©•ä¾¡ãƒœã‚¿ãƒ³ï¼ˆè£é¢è¡¨ç¤ºæ™‚ã®ã¿ï¼‰ -->
                <div id="ratingButtons" class="rating-buttons hidden">
                    <button class="rating-btn" onclick="rateCard(1)">é›£ã—ã„</button>
                    <button class="rating-btn" onclick="rateCard(2)">ã‚„ã‚„é›£</button>
                    <button class="rating-btn" onclick="rateCard(3)">æ™®é€š</button>
                    <button class="rating-btn" onclick="rateCard(4)">ã§ããŸ</button>
                    <button class="rating-btn" onclick="rateCard(5)">å®Œç’§</button>
                </div>
            </div>

            <!-- ç™ºéŸ³ç·´ç¿’ -->
            <div class="speech-practice">
                <h3>ç™ºéŸ³ç·´ç¿’</h3>
                <p>ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç™ºéŸ³ã—ã¦ãã ã•ã„</p>
                <button class="mic-button" onclick="startSpeechRecognition()">ğŸ¤</button>
                <div id="speechResult"></div>
                <div id="speechFeedback"></div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ -->
        <div id="dataManager" class="data-manager hidden">
            <div class="data-table">
                <div class="table-controls">
                    <h2>å˜èªãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                    <div class="filter-controls">
                        <input type="text" class="form-control" id="searchInput" placeholder="æ¤œç´¢...">
                        <select class="form-control" id="sectionFilter">
                            <option value="">å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³</option>
                        </select>
                        <select class="form-control" id="statusFilter">
                            <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                            <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                            <option value="å­¦ç¿’ä¸­">å­¦ç¿’ä¸­</option>
                            <option value="è‹¦æ‰‹ãƒ»è¦å¾©ç¿’">è‹¦æ‰‹ãƒ»è¦å¾©ç¿’</option>
                            <option value="å®šç€">å®šç€</option>
                            <option value="ç¿’å¾—æ¸ˆã¿">ç¿’å¾—æ¸ˆã¿</option>
                        </select>
                        <button class="btn btn-primary" onclick="showAddWordForm()">æ–°è¦è¿½åŠ </button>
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="loadWords()">æ›´æ–°</button>
                        <button class="btn btn-secondary" onclick="showSpreadsheetInfo()">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±</button>
                        <button class="btn btn-secondary" onclick="forceAddTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å¼·åˆ¶è¿½åŠ </button>
                        <button class="btn btn-secondary" onclick="showDebugInfo()">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>è¡¨é¢</th>
                                <th>è£é¢</th>
                                <th>ã‚»ã‚¯ã‚·ãƒ§ãƒ³</th>
                                <th>ã‚¿ã‚°</th>
                                <th>L</th>
                                <th>R</th>
                                <th>S</th>
                                <th>W</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="wordsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æ–°è¦è¿½åŠ ãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="wordForm" class="settings-panel hidden">
                <h3 id="formTitle">æ–°è¦å˜èªè¿½åŠ </h3>
                <form onsubmit="saveWord(event)">
                    <input type="hidden" id="wordId">
                    
                    <div class="setting-item">
                        <label class="setting-label">è¡¨é¢ï¼ˆè‹±èªç­‰ï¼‰*</label>
                        <input type="text" class="form-control" id="frontText" required>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">è£é¢ï¼ˆæ—¥æœ¬èªç­‰ï¼‰*</label>
                        <input type="text" class="form-control" id="backText" required>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ä¾‹æ–‡ãƒ»å‚™è€ƒ</label>
                        <textarea class="form-control" id="exampleText" rows="3"></textarea>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
                        <input type="text" class="form-control" id="sectionText">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                        <input type="text" class="form-control" id="tagsText">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">èª­ã¿ä¸Šã’ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                        <input type="text" class="form-control" id="readPattern" value="E1,J1">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">èª­ã¿ä¸Šã’é–“éš”ï¼ˆç§’ï¼‰</label>
                        <input type="number" class="form-control" id="readInterval" value="1" min="0.5" step="0.5">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ãƒ¡ãƒ¢1ï¼ˆã‚«ã‚¿ã‚«ãƒŠèª­ã¿ãªã©ï¼‰</label>
                        <input type="text" class="form-control" id="memo1">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ãƒ¡ãƒ¢2ï¼ˆç™ºéŸ³è¨˜å·ãªã©ï¼‰</label>
                        <input type="text" class="form-control" id="memo2">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ãƒ¡ãƒ¢3ï¼ˆç™ºéŸ³ã®ã‚³ãƒ„ãªã©ï¼‰</label>
                        <input type="text" class="form-control" id="memo3">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ãƒ¡ãƒ¢4</label>
                        <input type="text" class="form-control" id="memo4">
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">ãƒ¡ãƒ¢5</label>
                        <input type="text" class="form-control" id="memo5">
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        <button type="button" class="btn btn-secondary" onclick="hideWordForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¨­å®šç”»é¢ -->
        <div id="settings" class="settings-panel hidden">
            <h2>ã‚¢ãƒ—ãƒªè¨­å®š</h2>
            
            <!-- ãƒ¡ãƒ¢è¡¨ç¤ºè¨­å®š -->
            <div class="settings-section">
                <h3 class="settings-title">ãƒ¡ãƒ¢è¡¨ç¤ºè¨­å®š</h3>
                <div class="setting-item">
                    <span class="setting-label">è¡¨é¢ï¼ˆè‹±èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢1ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo1Front')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è£é¢ï¼ˆæ—¥æœ¬èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢1ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo1Back')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è¡¨é¢ï¼ˆè‹±èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢2ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo2Front')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è£é¢ï¼ˆæ—¥æœ¬èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢2ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo2Back')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è¡¨é¢ï¼ˆè‹±èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢3ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo3Front')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è£é¢ï¼ˆæ—¥æœ¬èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢3ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo3Back')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è¡¨é¢ï¼ˆè‹±èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢4ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo4Front')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è£é¢ï¼ˆæ—¥æœ¬èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢4ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo4Back')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è¡¨é¢ï¼ˆè‹±èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢5ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo5Front')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">è£é¢ï¼ˆæ—¥æœ¬èªï¼‰è¡¨ç¤ºæ™‚ã«ãƒ¡ãƒ¢5ã‚’è¡¨ç¤º</span>
                    <div class="toggle-switch" onclick="toggleSetting('showMemo5Back')"></div>
                </div>
            </div>

            <!-- ä¸€èˆ¬è¨­å®š -->
            <div class="settings-section">
                <h3 class="settings-title">ä¸€èˆ¬è¨­å®š</h3>
                <div class="setting-item">
                    <span class="setting-label">ã‚«ãƒ¼ãƒ‰ã‚ãã‚Šæ™‚ã«è‡ªå‹•èª­ã¿ä¸Šã’</span>
                    <div class="toggle-switch" onclick="toggleSetting('autoReadOnFlip')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">å­¦ç¿’é–‹å§‹æ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°</span>
                    <div class="toggle-switch active" onclick="toggleSetting('autoUpdateStatus')"></div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="resetSettings()">è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allWords = [];
        let currentWords = [];
        let currentIndex = 0;
        let isFlipped = false;
        let isPlaying = false;
        let speechRecognition = null;
        let audioContext = null;

        // è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let settings = {
            showMemo1Front: false,
            showMemo1Back: true,
            showMemo2Front: true,
            showMemo2Back: false,
            showMemo3Front: true,
            showMemo3Back: false,
            showMemo4Front: false,
            showMemo4Back: false,
            showMemo5Front: false,
            showMemo5Back: false,
            autoReadOnFlip: true,
            autoUpdateStatus: true
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
            initializeApp();
            loadSettings();
            setupEventListeners();
        });

        function initializeApp() {
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ä¸­...');
            
            // åˆæœŸåŒ–æ™‚ã¯ç©ºã®é…åˆ—ã§é–‹å§‹
            allWords = [];
            currentWords = [];
            currentIndex = 0;
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ
            loadWords();
            showStudyMode();
            
            // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
            if ('webkitSpeechRecognition' in window) {
                speechRecognition = new webkitSpeechRecognition();
                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;
                speechRecognition.lang = 'en-US';
                
                speechRecognition.onresult = function(event) {
                    const result = event.results[0][0].transcript;
                    console.log('éŸ³å£°èªè­˜çµæœ: ' + result);
                    processSpeechResult(result);
                };
                
                speechRecognition.onerror = function(event) {
                    console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error);
                    showMessage('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error, 'error');
                };
                
                console.log('éŸ³å£°èªè­˜æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
            } else {
                console.warn('éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
        }

        function setupEventListeners() {
            // èª­ã¿ä¸Šã’é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            document.getElementById('englishSpeed').addEventListener('input', function() {
                document.getElementById('englishSpeedValue').textContent = this.value;
            });
            
            document.getElementById('japaneseSpeed').addEventListener('input', function() {
                document.getElementById('japaneseSpeedValue').textContent = this.value;
            });

            // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            document.getElementById('searchInput').addEventListener('input', filterWords);
            document.getElementById('sectionFilter').addEventListener('change', filterWords);
            document.getElementById('statusFilter').addEventListener('change', filterWords);

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            document.addEventListener('keydown', function(event) {
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
                
                switch(event.code) {
                    case 'Space':
                        event.preventDefault();
                        flipCard();
                        break;
                    case 'ArrowLeft':
                        event.preventDefault();
                        prevCard();
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        nextCard();
                        break;
                    case 'KeyS':
                        event.preventDefault();
                        speakText();
                        break;
                }
            });
        }

        // ç”»é¢è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showStudyMode() {
            console.log('å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º');
            hideAllScreens();
            document.getElementById('studyMode').classList.remove('hidden');
            if (currentWords.length === 0) {
                loadWords();
            }
        }

        function showDataManager() {
            console.log('ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢è¡¨ç¤º');
            hideAllScreens();
            document.getElementById('dataManager').classList.remove('hidden');
            loadWords();
        }

        function showSettings() {
            console.log('è¨­å®šç”»é¢è¡¨ç¤º');
            hideAllScreens();
            document.getElementById('settings').classList.remove('hidden');
            updateSettingsUI();
        }

        function showReviewMode() {
            console.log('å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º');
            google.script.run
                .withSuccessHandler(function(reviewWords) {
                    console.log(`ä»Šæ—¥ã®å¾©ç¿’å¯¾è±¡: ${reviewWords.length}ä»¶`);
                    currentWords = reviewWords;
                    currentIndex = 0;
                    if (reviewWords.length > 0) {
                        showStudyMode();
                        displayCurrentCard();
                        showMessage(`ä»Šæ—¥ã®å¾©ç¿’å¯¾è±¡: ${reviewWords.length}ä»¶`, 'success');
                    } else {
                        showMessage('ä»Šæ—¥å¾©ç¿’ã™ã‚‹å˜èªã¯ã‚ã‚Šã¾ã›ã‚“ï¼', 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('å¾©ç¿’ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error);
                    showMessage('å¾©ç¿’ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                })
                .getTodayReviewWords();
        }

        function hideAllScreens() {
            document.getElementById('studyMode').classList.add('hidden');
            document.getElementById('dataManager').classList.add('hidden');
            document.getElementById('settings').classList.add('hidden');
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadWords() {
            console.log('=== loadWordsé–¢æ•°é–‹å§‹ ===');
            showLoading(true);
            
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–
            try {
                console.log('Google Apps Scriptã‚’å‘¼ã³å‡ºã—ä¸­...');
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        console.log('=== ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡ ===');
                        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ—:', typeof response);
                        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:', response);
                        
                        let words = response;
                        
                        // ã‚ˆã‚Šè©³ç´°ãªnullãƒã‚§ãƒƒã‚¯
                        if (response === null) {
                            console.error('ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒnullã§ã™');
                            console.log('ã“ã‚Œã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
                            showMessage('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', 'error');
                            words = [];
                        } else if (response === undefined) {
                            console.error('ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒundefinedã§ã™');
                            words = [];
                        } else if (!Array.isArray(response)) {
                            console.error('ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', typeof response);
                            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°:', JSON.stringify(response));
                            words = [];
                        }
                        
                        console.log(`å‡¦ç†å¯¾è±¡ã®å˜èªæ•°: ${words.length}`);
                        
                        // å„å˜èªã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°è¡¨ç¤º
                        if (words.length > 0) {
                            console.log('=== å—ä¿¡ã—ãŸå˜èªãƒ‡ãƒ¼ã‚¿ ===');
                            words.forEach((word, index) => {
                                console.log(`${index + 1}. ID:${word.id} ${word.front || '(ç©º)'} â†’ ${word.back || '(ç©º)'}`);
                                console.log(`   ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ${word.section || '(ãªã—)'}, ã‚¿ã‚°: ${word.tags || '(ãªã—)'}`);
                                console.log(`   èª­ã¿ä¸Šã’: ${word.readPattern || 'E1,J1'}, é–“éš”: ${word.readInterval || 1.0}ç§’`);
                                console.log(`   ãƒ¡ãƒ¢: 1="${word.memo1 || ''}", 2="${word.memo2 || ''}", 3="${word.memo3 || ''}"`);
                                console.log(`   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ - L:${word.statusListening || 'æœªç€æ‰‹'}, R:${word.statusReading || 'æœªç€æ‰‹'}, S:${word.statusSpeaking || 'æœªç€æ‰‹'}, W:${word.statusWriting || 'æœªç€æ‰‹'}`);
                                console.log('   ---');
                            });
                            console.log('========================');
                        }
                        
                        allWords = words;
                        currentWords = [...words];
                        currentIndex = 0;
                        
                        if (words.length === 0) {
                            console.log('å˜èªãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™');
                            showMessage('å˜èªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å¼·åˆ¶è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'error');
                        } else {
                            console.log(`å­¦ç¿’å¯èƒ½ãªå˜èª: ${words.length}ä»¶`);
                            showMessage(`${words.length}ä»¶ã®å˜èªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                        }
                        
                        displayCurrentCard();
                        updateWordsTable();
                        updateFilterOptions();
                        showLoading(false);
                        
                        console.log('=== loadWordså‡¦ç†å®Œäº† ===');
                    })
                    .withFailureHandler(function(error) {
                        console.error('=== ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ ===');
                        console.error('ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:', typeof error);
                        console.error('ã‚¨ãƒ©ãƒ¼å†…å®¹:', error);
                        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', JSON.stringify(error));
                        
                        showMessage('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
                        showLoading(false);
                        
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã®é…åˆ—ã§åˆæœŸåŒ–
                        allWords = [];
                        currentWords = [];
                        currentIndex = 0;
                        displayCurrentCard();
                        updateWordsTable();
                        
                        console.log('=== ã‚¨ãƒ©ãƒ¼å‡¦ç†å®Œäº† ===');
                    })
                    .getAllWords();
                    
                console.log('Google Apps Scriptå‘¼ã³å‡ºã—å®Œäº†ï¼ˆéåŒæœŸï¼‰');
                
            } catch (exception) {
                console.error('=== JavaScriptä¾‹å¤–ç™ºç”Ÿ ===');
                console.error('ä¾‹å¤–ã‚¿ã‚¤ãƒ—:', typeof exception);
                console.error('ä¾‹å¤–å†…å®¹:', exception);
                console.error('ä¾‹å¤–ã‚¹ã‚¿ãƒƒã‚¯:', exception.stack);
                
                showMessage('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: ' + exception.message, 'error');
                showLoading(false);
                
                console.log('=== ä¾‹å¤–å‡¦ç†å®Œäº† ===');
            }
        }

        // ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        function displayCurrentCard() {
            if (currentWords.length === 0) {
                document.getElementById('cardText').textContent = 'å­¦ç¿’ã™ã‚‹å˜èªãŒã‚ã‚Šã¾ã›ã‚“';
                document.getElementById('cardMemos').innerHTML = '<div class="card-memo">ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ã‹ã‚‰å˜èªã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
                updateStatusButtons();
                return;
            }

            const word = currentWords[currentIndex];
            console.log(`ã‚«ãƒ¼ãƒ‰è¡¨ç¤º: ${word.front} (${currentIndex + 1}/${currentWords.length})`);
            
            // åˆå›å­¦ç¿’æ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            if (settings.autoUpdateStatus && 
                (word.statusListening === 'æœªç€æ‰‹' || word.statusReading === 'æœªç€æ‰‹' || 
                 word.statusSpeaking === 'æœªç€æ‰‹' || word.statusWriting === 'æœªç€æ‰‹')) {
                updateWordStatusToLearning(word.id);
            }
            
            if (isFlipped) {
                document.getElementById('cardText').textContent = word.back || 'ï¼ˆè£é¢ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
                displayMemos(word, false); // è£é¢
                document.getElementById('ratingButtons').classList.remove('hidden');
            } else {
                document.getElementById('cardText').textContent = word.front || 'ï¼ˆè¡¨é¢ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
                displayMemos(word, true); // è¡¨é¢
                document.getElementById('ratingButtons').classList.add('hidden');
            }
            
            updateStatusButtons(word);
            
            if (settings.autoReadOnFlip) {
                setTimeout(() => speakText(), 500);
            }
        }

        function displayMemos(word, isFront) {
            const memosContainer = document.getElementById('cardMemos');
            memosContainer.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const memoText = word[`memo${i}`];
                const shouldShow = isFront ? 
                    settings[`showMemo${i}Front`] : 
                    settings[`showMemo${i}Back`];
                
                if (memoText && shouldShow) {
                    const memoDiv = document.createElement('div');
                    memoDiv.className = 'card-memo';
                    memoDiv.textContent = memoText;
                    memosContainer.appendChild(memoDiv);
                }
            }
        }

        function updateStatusButtons(word = null) {
            if (!word && currentWords.length > 0) {
                word = currentWords[currentIndex];
            }
            
            if (!word) {
                // å˜èªãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
                const skills = ['listening', 'reading', 'speaking', 'writing'];
                const labels = ['L', 'R', 'S', 'W'];
                
                skills.forEach((skill, index) => {
                    const button = document.querySelector(`[data-skill="${skill}"]`);
                    if (button) {
                        button.textContent = `${labels[index]}: æœªç€æ‰‹`;
                        button.className = `status-btn status-æœªç€æ‰‹`;
                    }
                });
                return;
            }
            
            const skills = ['listening', 'reading', 'speaking', 'writing'];
            const labels = ['L', 'R', 'S', 'W'];
            
            skills.forEach((skill, index) => {
                const button = document.querySelector(`[data-skill="${skill}"]`);
                if (button) {
                    const status = word[`status${skill.charAt(0).toUpperCase() + skill.slice(1)}`] || 'æœªç€æ‰‹';
                    button.textContent = `${labels[index]}: ${status}`;
                    button.className = `status-btn status-${status}`;
                }
            });
        }

        // ã‚«ãƒ¼ãƒ‰æ“ä½œ
        function flipCard() {
            console.log('ã‚«ãƒ¼ãƒ‰ãƒ•ãƒªãƒƒãƒ—');
            isFlipped = !isFlipped;
            displayCurrentCard();
        }

        function nextCard() {
            if (currentWords.length === 0) return;
            
            console.log('æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã¸');
            currentIndex = (currentIndex + 1) % currentWords.length;
            isFlipped = false;
            displayCurrentCard();
        }

        function prevCard() {
            if (currentWords.length === 0) return;
            
            console.log('å‰ã®ã‚«ãƒ¼ãƒ‰ã¸');
            currentIndex = currentIndex > 0 ? currentIndex - 1 : currentWords.length - 1;
            isFlipped = false;
            displayCurrentCard();
        }

        // èª­ã¿ä¸Šã’æ©Ÿèƒ½
        function speakText() {
            if (currentWords.length === 0) return;
            
            const word = currentWords[currentIndex];
            const text = isFlipped ? word.back : word.front;
            const lang = isFlipped ? 'ja-JP' : 'en-US';
            const speed = isFlipped ? 
                document.getElementById('japaneseSpeed').value : 
                document.getElementById('englishSpeed').value;
            
            console.log(`èª­ã¿ä¸Šã’: ${text} (è¨€èª: ${lang}, é€Ÿåº¦: ${speed})`);
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = parseFloat(speed);
                window.speechSynthesis.speak(utterance);
            }
        }

        function playCustomAudio() {
            if (currentWords.length === 0) return;
            
            console.log('ã‚«ã‚¹ã‚¿ãƒ èª­ã¿ä¸Šã’é–‹å§‹');
            isPlaying = true;
            
            const word = currentWords[currentIndex];
            const pattern = word.readPattern || 'E1,J1';
            const interval = (word.readInterval || 1) * 1000;
            
            playPattern(word, pattern.split(','), interval, 0);
        }

        function playPattern(word, patterns, interval, index) {
            if (!isPlaying || index >= patterns.length) {
                isPlaying = false;
                return;
            }
            
            const pattern = patterns[index].trim();
            const isEnglish = pattern.startsWith('E');
            const repeatCount = parseInt(pattern.substr(1)) || 1;
            
            for (let i = 0; i < repeatCount; i++) {
                setTimeout(() => {
                    if (!isPlaying) return;
                    
                    const text = isEnglish ? word.front : word.back;
                    const lang = isEnglish ? 'en-US' : 'ja-JP';
                    const speed = isEnglish ? 
                        document.getElementById('englishSpeed').value : 
                        document.getElementById('japaneseSpeed').value;
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    utterance.rate = parseFloat(speed);
                    window.speechSynthesis.speak(utterance);
                }, i * interval);
            }
            
            setTimeout(() => {
                playPattern(word, patterns, interval, index + 1);
            }, repeatCount * interval);
        }

        function stopAudio() {
            console.log('èª­ã¿ä¸Šã’åœæ­¢');
            isPlaying = false;
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
        function toggleStatus(skill) {
            if (currentWords.length === 0) return;
            
            const word = currentWords[currentIndex];
            const currentStatus = word[`status${skill.charAt(0).toUpperCase() + skill.slice(1)}`];
            
            const statusCycle = ['è‹¦æ‰‹ãƒ»è¦å¾©ç¿’', 'å®šç€', 'ç¿’å¾—æ¸ˆã¿'];
            let nextIndex = statusCycle.indexOf(currentStatus) + 1;
            if (nextIndex >= statusCycle.length) nextIndex = 0;
            
            const newStatus = statusCycle[nextIndex];
            console.log(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´: ${skill} ${currentStatus} -> ${newStatus}`);
            
            word[`status${skill.charAt(0).toUpperCase() + skill.slice(1)}`] = newStatus;
            updateStatusButtons(word);
            
            // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æˆåŠŸ');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error);
                })
                .updateWord(word);
        }

        function updateWordStatusToLearning(wordId) {
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        console.log('åˆå›å­¦ç¿’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å®Œäº†');
                        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                        const word = currentWords.find(w => w.id == wordId);
                        if (word) {
                            if (word.statusListening === 'æœªç€æ‰‹') word.statusListening = 'å­¦ç¿’ä¸­';
                            if (word.statusReading === 'æœªç€æ‰‹') word.statusReading = 'å­¦ç¿’ä¸­';
                            if (word.statusSpeaking === 'æœªç€æ‰‹') word.statusSpeaking = 'å­¦ç¿’ä¸­';
                            if (word.statusWriting === 'æœªç€æ‰‹') word.statusWriting = 'å­¦ç¿’ä¸­';
                            updateStatusButtons(word);
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('åˆå›å­¦ç¿’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error);
                })
                .updateStatusToLearning(wordId);
        }

        // SRSè©•ä¾¡
        function rateCard(quality) {
            if (currentWords.length === 0) return;
            
            const word = currentWords[currentIndex];
            console.log(`SRSè©•ä¾¡: ID=${word.id}, è©•ä¾¡=${quality}`);
            
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        console.log('SRSè©•ä¾¡é€ä¿¡å®Œäº†');
                        showMessage(`è©•ä¾¡ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ˆ${quality}/5ï¼‰`, 'success');
                        nextCard();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('SRSè©•ä¾¡ã‚¨ãƒ©ãƒ¼: ' + error);
                    showMessage('è©•ä¾¡ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                })
                .calculateNextReview(word.id, quality);
        }

        // ç™ºéŸ³ç·´ç¿’
        function startSpeechRecognition() {
            if (!speechRecognition) {
                showMessage('éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            if (currentWords.length === 0) return;
            
            console.log('éŸ³å£°èªè­˜é–‹å§‹');
            const micButton = document.querySelector('.mic-button');
            micButton.classList.add('recording');
            micButton.textContent = 'ğŸ”´';
            
            document.getElementById('speechResult').textContent = 'èãå–ã‚Šä¸­...';
            document.getElementById('speechFeedback').textContent = '';
            
            speechRecognition.start();
            
            setTimeout(() => {
                micButton.classList.remove('recording');
                micButton.textContent = 'ğŸ¤';
            }, 5000);
        }

        function processSpeechResult(result) {
            const word = currentWords[currentIndex];
            const target = word.front.toLowerCase().replace(/[^a-zA-Z\s]/g, '');
            const spoken = result.toLowerCase().replace(/[^a-zA-Z\s]/g, '');
            
            document.getElementById('speechResult').textContent = `èªè­˜çµæœ: "${result}"`;
            
            const similarity = calculateSimilarity(target, spoken);
            let feedback = '';
            let color = '';
            
            if (similarity > 0.8) {
                feedback = 'ç´ æ™´ã‚‰ã—ã„ç™ºéŸ³ã§ã™ï¼';
                color = '#28a745';
            } else if (similarity > 0.6) {
                feedback = 'è‰¯ã„ç™ºéŸ³ã§ã™ã€‚ã‚‚ã†å°‘ã—ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
                color = '#ffc107';
            } else {
                feedback = 'ç™ºéŸ³ã‚’è¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚æ­£è§£: "' + word.front + '"';
                color = '#dc3545';
            }
            
            const feedbackElement = document.getElementById('speechFeedback');
            feedbackElement.textContent = feedback;
            feedbackElement.style.color = color;
            
            console.log(`ç™ºéŸ³è©•ä¾¡: é¡ä¼¼åº¦=${similarity}, ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯=${feedback}`);
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        function updateWordsTable() {
            const tbody = document.getElementById('wordsTableBody');
            
            // nullãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
            if (!tbody) {
                console.error('wordsTableBodyè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            tbody.innerHTML = '';
            
            // currentWordsã®nullãƒã‚§ãƒƒã‚¯
            if (!currentWords || !Array.isArray(currentWords)) {
                console.log('currentWordsãŒç„¡åŠ¹ã§ã™:', currentWords);
                return;
            }
            
            console.log(`ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°: ${currentWords.length}ä»¶ã®å˜èªã‚’è¡¨ç¤º`);
            
            currentWords.forEach((word, index) => {
                if (!word) {
                    console.warn(`å˜èª${index}ãŒnullã§ã™`);
                    return;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${word.id || '(IDä¸æ˜)'}</td>
                    <td>${word.front || '(è¡¨é¢ãªã—)'}</td>
                    <td>${word.back || '(è£é¢ãªã—)'}</td>
                    <td>${word.section || '(ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãªã—)'}</td>
                    <td>${word.tags || '(ã‚¿ã‚°ãªã—)'}</td>
                    <td><span class="status-${word.statusListening || 'æœªç€æ‰‹'}">${word.statusListening || 'æœªç€æ‰‹'}</span></td>
                    <td><span class="status-${word.statusReading || 'æœªç€æ‰‹'}">${word.statusReading || 'æœªç€æ‰‹'}</span></td>
                    <td><span class="status-${word.statusSpeaking || 'æœªç€æ‰‹'}">${word.statusSpeaking || 'æœªç€æ‰‹'}</span></td>
                    <td><span class="status-${word.statusWriting || 'æœªç€æ‰‹'}">${word.statusWriting || 'æœªç€æ‰‹'}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="editWord(${word.id || 0})" style="margin-right: 0.5rem;">ç·¨é›†</button>
                        <button class="btn btn-secondary" onclick="deleteWordConfirm(${word.id || 0})" style="background: #dc3545; color: white;">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°å®Œäº†');
        }

        function updateFilterOptions() {
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°é–‹å§‹');
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
            const sectionFilter = document.getElementById('sectionFilter');
            if (!sectionFilter) {
                console.error('sectionFilterè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // allWordsã®nullãƒã‚§ãƒƒã‚¯
            if (!allWords || !Array.isArray(allWords)) {
                console.log('allWordsãŒç„¡åŠ¹ã§ã™:', allWords);
                sectionFilter.innerHTML = '<option value="">å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³</option>';
                return;
            }
            
            const sections = [...new Set(allWords.map(w => w && w.section).filter(s => s))];
            console.log('ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§:', sections);
            
            sectionFilter.innerHTML = '<option value="">å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionFilter.appendChild(option);
            });
            
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°å®Œäº†');
        }

        function filterWords() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const section = document.getElementById('sectionFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            currentWords = allWords.filter(word => {
                const matchesSearch = !search || 
                    word.front.toLowerCase().includes(search) ||
                    word.back.toLowerCase().includes(search) ||
                    word.tags.toLowerCase().includes(search);
                
                const matchesSection = !section || word.section === section;
                
                const matchesStatus = !status || 
                    word.statusListening === status ||
                    word.statusReading === status ||
                    word.statusSpeaking === status ||
                    word.statusWriting === status;
                
                return matchesSearch && matchesSection && matchesStatus;
            });
            
            console.log(`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ: ${currentWords.length}ä»¶`);
            updateWordsTable();
            currentIndex = 0;
            displayCurrentCard();
        }

        // å˜èªã®è¿½åŠ ãƒ»ç·¨é›†
        function showAddWordForm() {
            document.getElementById('formTitle').textContent = 'æ–°è¦å˜èªè¿½åŠ ';
            document.getElementById('wordForm').classList.remove('hidden');
            document.getElementById('wordId').value = '';
            clearWordForm();
        }

        function editWord(wordId) {
            const word = allWords.find(w => w.id == wordId);
            if (!word) return;
            
            document.getElementById('formTitle').textContent = 'å˜èªç·¨é›†';
            document.getElementById('wordForm').classList.remove('hidden');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('wordId').value = word.id;
            document.getElementById('frontText').value = word.front;
            document.getElementById('backText').value = word.back;
            document.getElementById('exampleText').value = word.example;
            document.getElementById('sectionText').value = word.section;
            document.getElementById('tagsText').value = word.tags;
            document.getElementById('readPattern').value = word.readPattern;
            document.getElementById('readInterval').value = word.readInterval;
            document.getElementById('memo1').value = word.memo1;
            document.getElementById('memo2').value = word.memo2;
            document.getElementById('memo3').value = word.memo3;
            document.getElementById('memo4').value = word.memo4;
            document.getElementById('memo5').value = word.memo5;
        }

        function hideWordForm() {
            document.getElementById('wordForm').classList.add('hidden');
            clearWordForm();
        }

        function clearWordForm() {
            const inputs = document.querySelectorAll('#wordForm input, #wordForm textarea');
            inputs.forEach(input => {
                if (input.id !== 'readPattern' && input.id !== 'readInterval') {
                    input.value = '';
                }
            });
            document.getElementById('readPattern').value = 'E1,J1';
            document.getElementById('readInterval').value = '1';
        }

        function saveWord(event) {
            event.preventDefault();
            
            const wordData = {
                id: document.getElementById('wordId').value,
                front: document.getElementById('frontText').value,
                back: document.getElementById('backText').value,
                example: document.getElementById('exampleText').value,
                section: document.getElementById('sectionText').value,
                tags: document.getElementById('tagsText').value,
                readPattern: document.getElementById('readPattern').value,
                readInterval: document.getElementById('readInterval').value,
                memo1: document.getElementById('memo1').value,
                memo2: document.getElementById('memo2').value,
                memo3: document.getElementById('memo3').value,
                memo4: document.getElementById('memo4').value,
                memo5: document.getElementById('memo5').value
            };
            
            console.log('å˜èªä¿å­˜:', wordData);
            
            const isEdit = !!wordData.id;
            const apiCall = isEdit ? 'updateWord' : 'addWord';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('å˜èªä¿å­˜æˆåŠŸ:', result);
                    showMessage(isEdit ? 'å˜èªã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ–°ã—ã„å˜èªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                    hideWordForm();
                    loadWords();
                })
                .withFailureHandler(function(error) {
                    console.error('å˜èªä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                })
                [apiCall](wordData);
        }

        function deleteWordConfirm(wordId) {
            const word = allWords.find(w => w.id == wordId);
            if (!word) return;
            
            if (confirm(`ã€Œ${word.front}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                console.log('å˜èªå‰Šé™¤:', wordId);
                
                google.script.run
                    .withSuccessHandler(function(success) {
                        if (success) {
                            console.log('å˜èªå‰Šé™¤æˆåŠŸ');
                            showMessage('å˜èªã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                            loadWords();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('å˜èªå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    })
                    .deleteWord(wordId);
            }
        }

        // è¨­å®šç®¡ç†
        function toggleSetting(settingName) {
            settings[settingName] = !settings[settingName];
            console.log(`è¨­å®šå¤‰æ›´: ${settingName} = ${settings[settingName]}`);
            updateSettingsUI();
            displayCurrentCard(); // ãƒ¡ãƒ¢è¡¨ç¤ºã‚’æ›´æ–°
        }

        function updateSettingsUI() {
            Object.keys(settings).forEach(key => {
                const toggle = document.querySelector(`[onclick="toggleSetting('${key}')"]`);
                if (toggle) {
                    if (settings[key]) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                }
            });
        }

        function saveSettings() {
            localStorage.setItem('wordAppSettings', JSON.stringify(settings));
            console.log('è¨­å®šä¿å­˜å®Œäº†');
            showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        function loadSettings() {
            const saved = localStorage.getItem('wordAppSettings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
                console.log('è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†');
            }
            updateSettingsUI();
        }

        function resetSettings() {
            if (confirm('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('wordAppSettings');
                settings = {
                    showMemo1Front: false,
                    showMemo1Back: true,
                    showMemo2Front: true,
                    showMemo2Back: false,
                    showMemo3Front: true,
                    showMemo3Back: false,
                    showMemo4Front: false,
                    showMemo4Back: false,
                    showMemo5Front: false,
                    showMemo5Back: false,
                    autoReadOnFlip: true,
                    autoUpdateStatus: true
                };
                updateSettingsUI();
                console.log('è¨­å®šãƒªã‚»ãƒƒãƒˆå®Œäº†');
                showMessage('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function showMessage(message, type = 'info') {
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const existingMessages = document.querySelectorAll('.error-message, .success-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function showLoading(show) {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®å®Ÿè£…
            const loadingElement = document.getElementById('loading');
            if (show) {
                if (!loadingElement) {
                    const loading = document.createElement('div');
                    loading.id = 'loading';
                    loading.innerHTML = '<div class="loading"></div> ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';
                    loading.style.textAlign = 'center';
                    loading.style.padding = '2rem';
                    document.querySelector('.container').insertBefore(loading, document.querySelector('.container').firstChild);
                }
            } else {
                if (loadingElement) {
                    loadingElement.remove();
                }
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function debugInfo() {
            console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
            console.log('å…¨å˜èªæ•°:', allWords.length);
            console.log('è¡¨ç¤ºä¸­å˜èªæ•°:', currentWords.length);
            console.log('ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', currentIndex);
            console.log('ç¾åœ¨ã®è¨­å®š:', settings);
            console.log('ã‚«ãƒ¼ãƒ‰ã®çŠ¶æ…‹ - ã‚ãã‚Š:', isFlipped);
            console.log('==================');
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        window.debugInfo = debugInfo;

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤º
        function showSpreadsheetInfo() {
            console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±å–å¾—é–‹å§‹');
            google.script.run
                .withSuccessHandler(function(info) {
                    console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè©³ç´°æƒ…å ±:', info);
                    let message = `=== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè©³ç´°æƒ…å ± ===\n`;
                    message += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå: ${info.spreadsheetName}\n`;
                    message += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID: ${info.spreadsheetId}\n`;
                    message += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${info.spreadsheetUrl}\n`;
                    message += `ã‚·ãƒ¼ãƒˆç·æ•°: ${info.sheetCount}\n`;
                    message += `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ãƒ¼ãƒˆå­˜åœ¨: ${info.targetSheetExists ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
                    message += `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ãƒ¼ãƒˆå: ${info.targetSheetName || 'ãªã—'}\n`;
                    message += `æœ€çµ‚è¡Œ: ${info.lastRow}\n`;
                    message += `æœ€çµ‚åˆ—: ${info.lastColumn}\n`;
                    message += `\nâ€»è©³ç´°ãªãƒ­ã‚°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã§ãã¾ã™`;
                    alert(message);
                })
                .withFailureHandler(function(error) {
                    console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                })
                .debugSpreadsheetInfo();
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å¼·åˆ¶è¿½åŠ 
        function forceAddTestData() {
            console.log('=== ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å¼·åˆ¶è¿½åŠ é–‹å§‹ ===');
            
            if (!confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶çš„ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã§ã‚‚5ã¤ã®ãƒ†ã‚¹ãƒˆå˜èªã‚’è¿½åŠ ã—ã¾ã™ï¼‰')) {
                return;
            }
            
            showLoading(true);
            showMessage('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ä¸­...', 'info');
            
            // ç›´æ¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const testWords = [
                {
                    front: 'Hello',
                    back: 'ã“ã‚“ã«ã¡ã¯',
                    example: 'Hello, how are you? - å…ƒæ°—ã§ã™ã‹ï¼Ÿ',
                    section: 'åŸºæœ¬ä¼šè©±',
                    tags: 'æŒ¨æ‹¶,æ—¥å¸¸ä¼šè©±',
                    readPattern: 'E2,J1,E1',
                    readInterval: 1.5,
                    memo1: 'ãƒ˜ãƒ­ãƒ¼',
                    memo2: '/hÉ™ËˆloÊŠ/',
                    memo3: 'ãƒã®éŸ³ã‚’æ„è­˜ã—ã¦'
                },
                {
                    front: 'Thank you',
                    back: 'ã‚ã‚ŠãŒã¨ã†',
                    example: 'Thank you very much. - ã©ã†ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚',
                    section: 'åŸºæœ¬ä¼šè©±',
                    tags: 'æŒ¨æ‹¶,æ„Ÿè¬',
                    readPattern: 'E1,J1',
                    readInterval: 1.0,
                    memo1: 'ã‚µãƒ³ã‚­ãƒ¥ãƒ¼',
                    memo2: '/Î¸Ã¦Å‹k juË/',
                    memo3: 'thã®éŸ³ã¯èˆŒã‚’è»½ãå™›ã‚“ã§'
                },
                {
                    front: 'Good morning',
                    back: 'ãŠã¯ã‚ˆã†',
                    example: 'Good morning! Have a nice day. - ãŠã¯ã‚ˆã†ï¼è‰¯ã„ä¸€æ—¥ã‚’ã€‚',
                    section: 'åŸºæœ¬ä¼šè©±',
                    tags: 'æŒ¨æ‹¶,æœ',
                    readPattern: 'E2,J1',
                    readInterval: 1.2,
                    memo1: 'ã‚°ãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°',
                    memo2: '/É¡ÊŠd ËˆmÉ”ËrnÉªÅ‹/',
                    memo3: 'ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã®æœ€å¾Œã¯è»½ã'
                },
                {
                    front: 'Beautiful',
                    back: 'ç¾ã—ã„',
                    example: 'What a beautiful day! - ãªã‚“ã¦ç¾ã—ã„æ—¥ã§ã—ã‚‡ã†ï¼',
                    section: 'å½¢å®¹è©',
                    tags: 'å½¢å®¹è©,æ„Ÿæƒ…',
                    readPattern: 'E3,J1',
                    readInterval: 1.0,
                    memo1: 'ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ•ãƒ«',
                    memo2: '/ËˆbjuËtÉªfÉ™l/',
                    memo3: 'ãƒ“ãƒ¥ãƒ¼ã®éƒ¨åˆ†ã‚’å¼·èª¿'
                },
                {
                    front: 'Important',
                    back: 'é‡è¦ãª',
                    example: 'This is very important. - ã“ã‚Œã¯ã¨ã¦ã‚‚é‡è¦ã§ã™ã€‚',
                    section: 'å½¢å®¹è©',
                    tags: 'å½¢å®¹è©,ãƒ“ã‚¸ãƒã‚¹',
                    readPattern: 'E2,J1,E1',
                    readInterval: 1.3,
                    memo1: 'ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ³ãƒˆ',
                    memo2: '/ÉªmËˆpÉ”ËrtÉ™nt/',
                    memo3: 'ãƒãƒ¼ã®éƒ¨åˆ†ã«ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ'
                }
            ];
            
            console.log(`${testWords.length}ä»¶ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é †æ¬¡è¿½åŠ é–‹å§‹`);
            
            // é †æ¬¡è¿½åŠ 
            let addedCount = 0;
            function addNextWord() {
                if (addedCount >= testWords.length) {
                    console.log('å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ å®Œäº†');
                    showMessage('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™...', 'success');
                    setTimeout(() => {
                        loadWords();
                    }, 1000);
                    return;
                }
                
                const word = testWords[addedCount];
                console.log(`ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿${addedCount + 1}ã‚’è¿½åŠ ä¸­: ${word.front}`);
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log(`ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿${addedCount + 1}è¿½åŠ æˆåŠŸ: ID=${result}`);
                        addedCount++;
                        setTimeout(addNextWord, 200); // å°‘ã—é–“éš”ã‚’ç©ºã‘ã¦æ¬¡ã‚’è¿½åŠ 
                    })
                    .withFailureHandler(function(error) {
                        console.error(`ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿${addedCount + 1}è¿½åŠ ã‚¨ãƒ©ãƒ¼:`, error);
                        showMessage(`ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${error}`, 'error');
                        showLoading(false);
                    })
                    .addWord(word);
            }
            
            addNextWord();
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—é–‹å§‹ ===');
            
            let debugInfo = '=== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===\n';
            debugInfo += `ç¾åœ¨æ™‚åˆ»: ${new Date()}\n`;
            debugInfo += `å…¨å˜èªæ•°: ${allWords ? allWords.length : 'null/undefined'}\n`;
            debugInfo += `è¡¨ç¤ºä¸­å˜èªæ•°: ${currentWords ? currentWords.length : 'null/undefined'}\n`;
            debugInfo += `ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${currentIndex}\n`;
            debugInfo += `ã‚«ãƒ¼ãƒ‰ã®çŠ¶æ…‹: ${isFlipped ? 'è£é¢' : 'è¡¨é¢'}\n`;
            debugInfo += `éŸ³å£°å†ç”Ÿä¸­: ${isPlaying}\n`;
            debugInfo += `éŸ³å£°èªè­˜å¯¾å¿œ: ${speechRecognition ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
            debugInfo += `Speech Synthesiså¯¾å¿œ: ${'speechSynthesis' in window ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
            debugInfo += `ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}\n`;
            debugInfo += '\n';
            
            if (allWords && allWords.length > 0) {
                debugInfo += '=== ç¾åœ¨ã®å˜èªãƒªã‚¹ãƒˆ ===\n';
                allWords.slice(0, 5).forEach((word, index) => {
                    debugInfo += `${index + 1}. ${word.front} â†’ ${word.back}\n`;
                });
                if (allWords.length > 5) {
                    debugInfo += `... ãã®ä»–${allWords.length - 5}ä»¶\n`;
                }
            }
            
            console.log(debugInfo);
            
            // ã‚µãƒ¼ãƒãƒ¼å´ã®è©³ç´°æƒ…å ±ã‚‚å–å¾—
            console.log('ã‚µãƒ¼ãƒãƒ¼å´ã®è©³ç´°æƒ…å ±ã‚’å–å¾—ä¸­...');
            google.script.run
                .withSuccessHandler(function(serverInfo) {
                    console.log('=== ã‚µãƒ¼ãƒãƒ¼å´ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===', serverInfo);
                    
                    let fullDebugInfo = debugInfo + '\n=== ã‚µãƒ¼ãƒãƒ¼å´ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===\n';
                    fullDebugInfo += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå: ${serverInfo.spreadsheetName}\n`;
                    fullDebugInfo += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID: ${serverInfo.spreadsheetId}\n`;
                    fullDebugInfo += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL: ${serverInfo.spreadsheetUrl}\n`;
                    fullDebugInfo += `ã‚·ãƒ¼ãƒˆç·æ•°: ${serverInfo.sheetCount}\n`;
                    fullDebugInfo += `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ãƒ¼ãƒˆå­˜åœ¨: ${serverInfo.targetSheetExists ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
                    fullDebugInfo += `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ãƒ¼ãƒˆå: ${serverInfo.targetSheetName || 'ãªã—'}\n`;
                    fullDebugInfo += `æœ€çµ‚è¡Œ: ${serverInfo.lastRow}\n`;
                    fullDebugInfo += `æœ€çµ‚åˆ—: ${serverInfo.lastColumn}\n`;
                    
                    alert(fullDebugInfo);
                })
                .withFailureHandler(function(error) {
                    console.error('ã‚µãƒ¼ãƒãƒ¼å´ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    alert(debugInfo + '\n=== ã‚µãƒ¼ãƒãƒ¼å´ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===\nã‚¨ãƒ©ãƒ¼: ' + error);
                })
                .debugSpreadsheetInfo();
        }
    </script>
</body>
</html>